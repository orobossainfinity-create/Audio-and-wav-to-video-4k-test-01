<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image + Audio → Video (Cloudflare Pages)</title>
  <style>
    body {
      background:#000;
      color:#ffd700;
      font-family:Arial,sans-serif;
      margin:0;
      padding:20px;
      text-align:center;
    }
    .container { max-width:600px; margin:auto; }
    h1 { font-size:2.2rem; margin-bottom:15px; }
    .warning {
      background:#300;
      border:1px solid #c00;
      padding:12px;
      margin:15px 0;
      border-radius:8px;
      font-size:0.95rem;
    }
    input[type=text] {
      width:100%;
      padding:12px;
      margin:10px 0;
      background:#111;
      color:#ffd700;
      border:1px solid #d4af37;
      border-radius:6px;
      font-size:1rem;
    }
    button {
      padding:14px 40px;
      font-size:1.3rem;
      background:#d4af37;
      color:#000;
      border:none;
      border-radius:8px;
      cursor:pointer;
      margin:20px 0;
    }
    #status { margin:20px 0; min-height:40px; font-size:1.2rem; }
    .progress {
      width:100%;
      height:20px;
      background:#111;
      border:1px solid #d4af37;
      border-radius:10px;
      overflow:hidden;
      display:none;
      margin:15px 0;
    }
    .progress-bar {
      height:100%;
      width:0%;
      background:#ffd700;
      transition:width 0.6s;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Image + Audio → Video</h1>

    <div class="warning">
      <strong>Cloudflare Pages version</strong><br>
      Max total size ~50 MB (image + audio).<br>
      Use direct URLs (not share links).<br>
      Test with tiny files first!
    </div>

    <label>Image URL (jpg/png):</label><br>
    <input type="text" id="imgUrl" placeholder="https://i.imgur.com/tiny.jpg"><br><br>

    <label>Audio URL (mp3/wav):</label><br>
    <input type="text" id="audUrl" placeholder="https://example.com/short.mp3"><br><br>

    <button onclick="start()">Begin Conversion</button>

    <div id="status">Ready...</div>
    <div class="progress" id="prog"><div class="progress-bar" id="bar"></div></div>
  </div>

  <script type="module">
    import { FFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/ffmpeg.js';
    import { fetchFile, toBlobURL } from 'https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js';

    const MAX_BYTES = 50 * 1024 * 1024;

    async function start() {
      const status = document.getElementById('status');
      const prog = document.getElementById('prog');
      const bar = document.getElementById('bar');

      status.textContent = 'Starting...';
      prog.style.display = 'block';
      bar.style.width = '5%';

      const ffmpeg = new FFmpeg({ log: true });

      try {
        status.textContent = 'Loading engine (30–120s on phone)...';
        const base = 'https://unpkg.com/@ffmpeg/core-mt@0.12.6/dist/umd';
        await ffmpeg.load({
          coreURL: await toBlobURL(`${base}/ffmpeg-core.js`, 'text/javascript'),
          wasmURL: await toBlobURL(`${base}/ffmpeg-core.wasm`, 'application/wasm'),
          workerURL: await toBlobURL(`${base}/ffmpeg-worker.js`, 'application/javascript')
        });

        bar.style.width = '20%';
        status.textContent = 'Fetching files...';

        const imgUrl = document.getElementById('imgUrl').value.trim();
        const audUrl = document.getElementById('audUrl').value.trim();
        if (!imgUrl || !audUrl) throw new Error('Both URLs required');

        const imgRes = await fetch(imgUrl);
        const audRes = await fetch(audUrl);
        if (!imgRes.ok || !audRes.ok) throw new Error('Invalid URLs');

        const imgBuf = await imgRes.arrayBuffer();
        const audBuf = await audRes.arrayBuffer();

        const total = imgBuf.byteLength + audBuf.byteLength;
        if (total > MAX_BYTES) throw new Error(`Total >50MB (${Math.round(total/1024/1024)}MB)`);

        bar.style.width = '35%';
        status.textContent = 'Encoding (may take minutes)...';

        const audExt = audUrl.split('.').pop().toLowerCase() || 'mp3';
        await ffmpeg.writeFile('img.jpg', new Uint8Array(imgBuf));
        await ffmpeg.writeFile(`aud.${audExt}`, new Uint8Array(audBuf));

        await ffmpeg.exec([
          '-loop', '1', '-i', 'img.jpg',
          '-i', `aud.${audExt}`,
          '-c:v', 'libx264', '-crf', '28', '-preset', 'ultrafast',
          '-vf', 'scale=854:480:force_original_aspect_ratio=decrease,pad=854:480:(ow-iw)/2:(oh-ih)/2',
          '-c:a', 'aac', '-b:a', '96k',
          '-shortest', '-y', 'out.mp4'
        ]);

        bar.style.width = '100%';
        status.textContent = 'Done! Starting download...';

        const data = await ffmpeg.readFile('out.mp4');
        const blob = new Blob([data.buffer], { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'video.mp4';
        a.click();

      } catch (e) {
        console.error(e);
        status.textContent = 'Error: ' + (e.message || 'Failed – check console');
        bar.style.background = '#c00';
      }
    }
  </script>
</body>
  </html>
